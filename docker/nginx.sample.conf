# --- 全域設定 ---
worker_processes auto;  # 預設值: auto。建議設為 auto 以利用多核 CPU。
rtmp_auto_push on;      # 預設值: off。多進程模式下必開，否則統計數據(Stat)會不完整。

events {
    worker_connections 2048; # 預設值: 512。定義單一 worker 能處理的最大連線數。
}

# --- RTMP 服務配置 ---
rtmp {
    server {
        listen 1935;             # 預設值: 1935。RTMP 標準通訊埠。
        chunk_size 4000;         # 預設值: 4096。每個傳輸塊的大小。
        timeout 60s;             # 預設值: 60s。連線超時時間。
        ping 30s;                # 預設值: 30s。RTMP 活體檢查頻率。
        ping_timeout 10s;        # 預設值: 10s。Ping 發出後多久沒回應視為斷線。

        # =====================================================================
        # ⚠️ 重要：後端整合與授權驗證 (Webhook) 設定
        # =====================================================================
        # 1. 運作機制：Nginx 會發送 HTTP POST 請求到你的 API。
        # 2. 【關鍵】狀態碼限制：
        #    - 你的 API 必須回傳 HTTP 2xx (如 200 OK)，Nginx 才會允許動作繼續。
        #    - 若回傳 4xx 或 5xx，Nginx 會立即拒絕連線或中斷直播。
        # 3. ⚠️ 下列網址必須修改為你真實的後端位址 (如 http://192.168.x.x:9011/...)
        # 4. ⚠️ 若不需要後端驗證，請將下列 "on_xxx" 指令全部註解掉。
        # =====================================================================

        # [1. 全域連線驗證] - 第一道關卡
        # 只要有人連上伺服器就會觸發。若回傳非 2xx，連線會被直接切斷。
        on_connect <YOUR_BACKEND_ON_CONNECTION_API>;

        # [2. 推流權限驗證] - 直播主身分檢查
        # 用來檢查 Stream Key。若回傳非 2xx，直播主會收到推流失敗 (I/O Error)。
        on_publish <YOUR_BACKEND_ON_PUSHLISH_API>;

        # [3. 播放權限驗證] - 觀眾看片檢查
        # 用來檢查觀眾是否有權限。若回傳非 2xx，觀眾將無法取得畫面。
        on_play    <YOUR_BACKEND_ON_PLAY_API>;

        # [4. 結束/統計通知] - 僅作為通知
        # 當推流結束或觀眾離開時觸發。回傳非 2xx 不會影響已結束的連線，但建議回傳 200。
        on_done    <YOUR_BACKEND_ON_DONE_API>;

        # [5. 即時數據監控] - 流量計費與時長統計
        # 每隔 30 秒回報目前的流量(bytes)與時長(time)。
        on_update  <YOUR_BACKEND_ON_UPDATE_API>;;
        notify_update_timeout 30s; # 預設值: 30s。
        notify_update_strict off;  # 預設值: off。設為 on 則代表 update 失敗也會踢掉直播主。

        # --- 應用程式設定 ---
        application live {
            live on;             # 預設值: off。開啟直播模式。
            record off;          # 預設值: off。關閉伺服器錄製。

            # --- HLS 轉碼 (低延遲優化) ---
            hls on;                      # 預設值: off。開啟轉碼。
            hls_path /tmp/hls;           # 無預設值。ts/m3u8 暫存路徑。
            hls_fragment 3s;             # 預設值: 5s。切片長度，影響延遲。
            hls_playlist_length 60s;     # 預設值: 30s。
            hls_cleanup on;              # 預設值: on。自動清理舊切片。
            hls_continuous on;           # 預設值: on。

            # --- 串流優化 ---
            wait_key on;        # 預設值: off。強制從關鍵幀開始播放，防止第一秒花屏。
            wait_video on;      # 預設值: off。
            idle_streams off;   # 預設值: on。關閉後，推流一斷開，觀眾會立即斷開不留殘影。
            drop_idle_publisher 10s; # 預設值: 無。
            interleave on;      # 預設值: off。交錯傳輸音視頻，網路更平滑。
        }
    }
}

# --- HTTP 服務配置 ---
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;                # 預設值: off。
    tcp_nopush    on;                # 預設值: off。
    keepalive_timeout 65;            # 預設值: 75s。

    server {
        listen 80;

        # [HLS 靜態檔案路徑]
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            alias /tmp/hls;
            add_header Cache-Control no-cache;            # HLS 播放列表不可快取。
            add_header 'Access-Control-Allow-Origin' '*'; # 必開！否則瀏覽器無法播放。
            expires -1;
        }

        # [RTMP 狀態監視器]
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            add_header 'Access-Control-Allow-Origin' '*';
        }

        location /stat.xsl {
            root /www/static;
        }

        # [控制 API]
        location /control {
            rtmp_control all;
            add_header 'Access-Control-Allow-Origin' '*';
        }

        # [健康檢查]
        location /health {
            default_type application/json;
            return 200 '{"status": "OK"}';
        }
    }
}